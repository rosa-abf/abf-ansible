---

- include: hosts.yml

- name: set default rvm gemset
  shell: rvm ruby-{{ ruby_version }} do rvm --default use {{ ruby_version }}@abf-worker --create

- name: add abf-worker-service repo
  copy: >
    src=rosa-server65/abf-worker-service.repo
    dest=/etc/yum.repos.d/abf-worker-service.repo
    owner=root group=root mode=0644
  sudo: yes
  when: platform_name == "rosa-server65"

- name: install the latest version of lxc, ...
  yum: pkg={{ item }} state=present
  sudo: yes
  with_items:
    - lxc
    - redir
    - bsdtar
    - procmail

- name: Creates store directory
  sudo: yes
  file: path={{ store_path }} state=directory mode=777 owner={{ user }} group={{ user }}

- name: Create directories
  file: path={{ item }} state=directory
  with_items:
    - "{{ deploy_to }}"
    - "{{ deploy_to }}/shared/config"
    - "{{ deploy_to }}/shared/log"
    - "{{ deploy_to }}/shared/pids"
    - "{{ store_path }}/lxc-containers"
    - "{{ store_path }}/tmp"
    - "{{ store_path }}/tmp-vagrant-boxes"
    - "{{ store_path }}/vagrant-boxes"
    - "/home/{{ user }}/.vagrant.d"

- name: Create links
  file: src={{ item.src }} dest={{ item.dest }} state=link
  with_items:
    - { src: '{{ store_path }}/vagrant-boxes', dest: '/home/{{ user }}/boxes' }
    - { src: '{{ store_path }}/tmp-vagrant-boxes', dest: '/home/{{ user }}/.vagrant.d/boxes' }

- name: removes def /var/lib/lxc directory
  sudo: yes
  file: path=/var/lib/lxc state=absent

- name: creates link to /var/lib/lxc directory
  sudo: yes
  file: >
    src={{ store_path }}/lxc-containers
    dest=/var/lib/lxc
    state=link

- name: creates resque.yml
  template: src=resque.yml dest={{ deploy_to }}/shared/config/resque.yml owner={{ user }}

- name: creates application.yml
  template: src=application.yml dest={{ deploy_to }}/shared/config/application.yml owner={{ user }}

# - name: clone repo
#   git: >
#     repo={{ repo }}
#     version={{ branch }}
#     dest={{ deploy_to }}/scm
#     update=true force=true bare=true
#   environment:
#     GIT_SSL_NO_VERIFY: true
#   register: clone_result


